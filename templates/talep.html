{% extends "base.html" %}
{% block title %}Talep Takip{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center">
  <h2>Talep Takibi</h2>
</div>

<div class="d-flex gap-2 mb-3">
  <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addModal" style="height:40px;">Talep Aç</button>
  <button id="transfer-selected" type="button" class="btn btn-primary" style="height:40px;">Giriş</button>
  <button id="stock-transfer-selected" type="button" class="btn btn-warning" style="height:40px;">Stok Giriş</button>
  <button id="delete-selected" type="button" class="btn btn-danger" style="height:40px;">Sil</button>
</div>

<div class="modal fade" id="addModal" tabindex="-1" aria-labelledby="addModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addModalLabel">Talep Aç</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
      </div>
      <form action="/requests/add" method="post">
        <div class="modal-body">
          <div id="request-rows" class="d-flex flex-column gap-2">
            <div class="row g-2 request-row">
                <div class="col">
                  <select class="form-select type-select" name="kategori">
                    <option value="donanim">Donanım</option>
                    <option value="lisans">Lisans</option>
                    <option value="aksesuar">Aksesuar</option>
                  </select>
                </div>
                <div class="col donanim-field">
                  <select class="form-select donanim-tipi" name="donanim_tipi">
                    <option value="">Donanım Tipi</option>
                    {% for val in lookups.donanim_tipi %}
                    <option value="{{ val }}">{{ val }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="col donanim-field">
                  <select class="form-select marka" name="marka">
                    <option value="">Marka</option>
                    {% for val in lookups.marka %}
                    <option value="{{ val }}">{{ val }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="col donanim-field">
                  <select class="form-select model" name="model">
                    <option value="">Model</option>
                    {% for val in lookups.model %}
                    <option value="{{ val }}">{{ val }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="col lisans-field d-none">
                  <select class="form-select yazilim-adi" name="yazilim_adi">
                    <option value="">Yazılım Adı</option>
                    {% for val in lookups.yazilim_adi %}
                    <option value="{{ val }}">{{ val }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="col aksesuar-field d-none">
                  <select class="form-select urun-adi">
                    <option value="">Ürün Adı</option>
                    {% for val in lookups.urun_adi %}
                    <option value="{{ val }}">{{ val }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="col">
                  <input type="number" class="form-control adet" name="adet" placeholder="Adet" min="1" required>
                </div>
                <div class="col">
                  <input type="text" class="form-control ifs-no" name="ifs_no" placeholder="IFS No" required>
                </div>
                <div class="col-auto">
                  <button type="button" class="btn btn-danger remove-row" style="width:40px;height:40px;display:flex;align-items:center;justify-content:center;">
                    <i class="bi bi-dash"></i>
                  </button>
                </div>
              <input type="hidden" name="urun_adi">
              <input type="hidden" name="tarih" value="{{ today }}">
              <input type="hidden" name="aciklama">
            </div>
          </div>
          <button type="button" id="add-row" class="btn btn-outline-secondary mt-2" style="width:40px;height:40px;display:flex;align-items:center;justify-content:center;">
            <i class="bi bi-plus"></i>
          </button>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-success">Kaydet</button>
        </div>
      </form>
</div>
</div>
</div>

<div class="modal fade" id="transferModal" tabindex="-1" aria-labelledby="transferModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="transferModalLabel">Eksik Bilgileri Girin</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
      </div>
      <div class="modal-body">
        <div id="transfer-rows" class="d-flex flex-column gap-2"></div>
      </div>
      <div class="modal-footer">
        <button type="button" id="confirm-transfer" class="btn btn-primary">Kaydet</button>
      </div>
</div>
</div>
</div>

<div class="modal fade" id="stockTransferModal" tabindex="-1" aria-labelledby="stockTransferModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="stockTransferModalLabel">Stok Giriş</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
      </div>
      <div class="modal-body">
        <div id="stock-transfer-rows" class="d-flex flex-column gap-2"></div>
      </div>
      <div class="modal-footer">
        <button type="button" id="confirm-stock-transfer" class="btn btn-warning">Kaydet</button>
      </div>
    </div>
  </div>
</div>

<table class="table table-striped" id="request-table">
  <tr>
    <th><input type="checkbox" id="select-all"></th>
    <th>Ürün Adı</th>
    <th>Adet</th>
    <th>IFS No</th>
    <th>Açıklama</th>
    <th>Tarih</th>
    <th>Talep Açan</th>
  </tr>
  {% for ifs, items in groups.items() %}
    <tr>
      <td><input class="form-check-input row-check" type="checkbox" value="{{ items[0].id }}" data-kategori="{{ items[0].kategori }}"></td>
      <td>
        {% if items|length > 1 %}
        <button type="button" class="btn btn-link p-0 toggle-group" data-group="{{ ifs }}">
          <i class="bi bi-caret-right-fill"></i>
        </button>
        {% endif %}
        {{ items[0].urun_adi }}
      </td>
      <td>{{ items[0].adet }}</td>
      <td>{{ items[0].ifs_no }}</td>
      <td>{{ items[0].aciklama }}</td>
      <td>{{ items[0].tarih }}</td>
      <td>{{ items[0].talep_acan }}</td>
    </tr>
    {% for item in items[1:] %}
    <tr class="group-{{ ifs }} d-none">
      <td><input class="form-check-input row-check" type="checkbox" value="{{ item.id }}" data-kategori="{{ item.kategori }}"></td>
      <td>{{ item.urun_adi }}</td>
      <td>{{ item.adet }}</td>
      <td>{{ item.ifs_no }}</td>
      <td>{{ item.aciklama }}</td>
      <td>{{ item.tarih }}</td>
      <td>{{ item.talep_acan }}</td>
    </tr>
    {% endfor %}
  {% endfor %}
</table>
{% endblock %}

{% block scripts %}
<script>
let transferCategory = null;
document.getElementById('select-all').addEventListener('change', function(){
  document.querySelectorAll('.row-check').forEach(cb => cb.checked = this.checked);
});
document.getElementById('transfer-selected').addEventListener('click', function(){
  const checks = Array.from(document.querySelectorAll('.row-check:checked'));
  if(!checks.length){
    showAlert('Lütfen kayıt seçin');
    return;
  }
  transferCategory = checks[0].dataset.kategori;
  const container = document.getElementById('transfer-rows');
  container.innerHTML = '';
  checks.forEach(cb => {
    const tr = cb.closest('tr');
    const urun = tr.children[1].innerText.trim();
    const ifsNo = tr.children[3].innerText.trim();
    const maxQty = parseInt(tr.children[2].innerText.trim());
    const div = document.createElement('div');
    div.className = 'transfer-row d-flex flex-column gap-2';
    if(transferCategory === 'lisans'){
      div.innerHTML = `
        <input type="hidden" name="id" value="${cb.value}">
        <div>${urun}</div>
        <input type="number" class="form-control adet" placeholder="Adet" min="1" max="${maxQty}">
        <input type="text" class="form-control departman" placeholder="Departman">
        <input type="text" class="form-control kullanici" placeholder="Kullanıcı">
        <input type="text" class="form-control lisans_anahtari" placeholder="Lisans Anahtarı">
        <input type="text" class="form-control mail_adresi" placeholder="Mail Adresi">
        <input type="text" class="form-control envanter_no" placeholder="Envanter No" value="${ifsNo}">
        <input type="text" class="form-control notlar" placeholder="Notlar">
      `;
    } else if(transferCategory === 'donanim'){
      div.innerHTML = `
        <input type="hidden" name="id" value="${cb.value}">
        <div>${urun}</div>
        <input type="number" class="form-control adet" placeholder="Adet" min="1" max="${maxQty}">
        <input type="text" class="form-control fabrika" placeholder="Fabrika">
        <input type="text" class="form-control blok" placeholder="Blok">
        <input type="text" class="form-control departman" placeholder="Departman">
        <input type="text" class="form-control bilgisayar_adi" placeholder="Bilgisayar Adı">
        <input type="text" class="form-control seri_no" placeholder="Seri No">
        <input type="text" class="form-control sorumlu_personel" placeholder="Sorumlu Personel">
        <select class="form-select kullanim_alani">
          <option value="">Kullanım Alanı</option>
          <option value="Kullanıcı">Kullanıcı</option>
          <option value="Üretim">Üretim</option>
        </select>
        <input type="text" class="form-control bagli_makina_no d-none" placeholder="Bağlı Olduğu Makina">
      `;
      const usageSelect = div.querySelector('.kullanim_alani');
      const machineInput = div.querySelector('.bagli_makina_no');
      usageSelect.addEventListener('change', () => {
        if(usageSelect.value === 'Üretim'){
          machineInput.classList.remove('d-none');
        } else {
          machineInput.classList.add('d-none');
          machineInput.value = '';
        }
      });
    } else {
      div.innerHTML = `
        <input type="hidden" name="id" value="${cb.value}">
        <div>${urun}</div>
        <input type="number" class="form-control adet" placeholder="Adet" min="1" max="${maxQty}">
        <input type="text" class="form-control departman" placeholder="Departman">
      `;
    }
    container.appendChild(div);
  });
  const modal = new bootstrap.Modal(document.getElementById('transferModal'));
  modal.show();
});
document.getElementById('confirm-transfer').addEventListener('click', function(){
  const rows = document.querySelectorAll('#transfer-rows .transfer-row');
  let valid = true;
  let maxExceeded = false;
  const items = Array.from(rows).map(row => {
    const departman = row.querySelector('.departman').value.trim();
    const adetInput = row.querySelector('.adet');
    const adet = parseInt(adetInput.value);
    const max = parseInt(adetInput.getAttribute('max'));
    if(!departman || isNaN(adet) || adet <= 0){
      valid = false;
    }
    if(adet > max){
      maxExceeded = true;
      valid = false;
    }
    const item = {
      id: parseInt(row.querySelector('input[name="id"]').value),
      departman: departman,
      adet: adet
    };
    if(transferCategory === 'lisans'){
      const kullanici = row.querySelector('.kullanici').value.trim();
      const lisans = row.querySelector('.lisans_anahtari').value.trim();
      const mail = row.querySelector('.mail_adresi').value.trim();
      const env = row.querySelector('.envanter_no').value.trim();
      const note = row.querySelector('.notlar').value.trim();
      if(!kullanici || !lisans || !env){
        valid = false;
      }
      item.kullanici = kullanici;
      item.lisans_anahtari = lisans;
      item.mail_adresi = mail;
      item.envanter_no = env;
      item.notlar = note;
    } else if(transferCategory === 'donanim'){
      const fabrika = row.querySelector('.fabrika').value.trim();
      const blok = row.querySelector('.blok').value.trim();
      const bilgisayarAdi = row.querySelector('.bilgisayar_adi').value.trim();
      const seriNo = row.querySelector('.seri_no').value.trim();
      const sorumlu = row.querySelector('.sorumlu_personel').value.trim();
      const kullanim = row.querySelector('.kullanim_alani').value;
      const bagliMakina = row.querySelector('.bagli_makina_no').value.trim();
      if(!fabrika || !blok || !sorumlu || !kullanim){
        valid = false;
      }
      item.fabrika = fabrika;
      item.blok = blok;
      item.bilgisayar_adi = bilgisayarAdi;
      item.seri_no = seriNo;
      item.sorumlu_personel = sorumlu;
      item.kullanim_alani = kullanim;
      item.bagli_makina_no = bagliMakina;
    }
    return item;
  });
  if(!valid){
    if(maxExceeded){
      showAlert('Adet talep edilen miktarı aşamaz');
    } else {
      showAlert('Lütfen tüm alanları doldurun');
    }
    return;
  }
  fetch('/requests/transfer', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({items: items})
  }).then(r => r.json()).then(() => {
    if(transferCategory === 'lisans'){
      window.location.href = '/license';
    } else if(transferCategory === 'donanim'){
      window.location.href = '/inventory';
    } else if(transferCategory === 'aksesuar'){
      window.location.href = '/accessories';
    } else {
      location.reload();
    }
  });
});
document.getElementById('stock-transfer-selected').addEventListener('click', function(){
  const checks = Array.from(document.querySelectorAll('.row-check:checked'));
  if(!checks.length){
    showAlert('Lütfen kayıt seçin');
    return;
  }
  const container = document.getElementById('stock-transfer-rows');
  container.innerHTML = '';
  checks.forEach(cb => {
    const tr = cb.closest('tr');
    const urun = tr.children[1].innerText.trim();
    const maxQty = parseInt(tr.children[2].innerText.trim());
    const div = document.createElement('div');
    div.className = 'row g-2 stock-transfer-row';
    div.innerHTML = `
      <input type="hidden" name="id" value="${cb.value}">
      <div class="col">${urun}</div>
      <div class="col"><input type="number" class="form-control adet" placeholder="Adet" min="1" max="${maxQty}"></div>
    `;
    container.appendChild(div);
  });
  const modal = new bootstrap.Modal(document.getElementById('stockTransferModal'));
  modal.show();
});
document.getElementById('confirm-stock-transfer').addEventListener('click', function(){
  const rows = document.querySelectorAll('#stock-transfer-rows .stock-transfer-row');
  let valid = true;
  let maxExceeded = false;
  const items = Array.from(rows).map(row => {
    const adetInput = row.querySelector('.adet');
    const adet = parseInt(adetInput.value);
    const max = parseInt(adetInput.getAttribute('max'));
    if(isNaN(adet) || adet <= 0){
      valid = false;
    }
    if(adet > max){
      maxExceeded = true;
      valid = false;
    }
    return {
      id: parseInt(row.querySelector('input[name="id"]').value),
      adet: adet
    };
  });
  if(!valid){
    if(maxExceeded){
      showAlert('Adet talep edilen miktarı aşamaz');
    } else {
      showAlert('Lütfen tüm alanları doldurun');
    }
    return;
  }
  fetch('/requests/stock_transfer', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({items: items})
  }).then(r => r.json()).then(() => location.reload());
});
document.getElementById('delete-selected').addEventListener('click', function(){
  const ids = Array.from(document.querySelectorAll('.row-check:checked')).map(cb => parseInt(cb.value));
  if(!ids.length){
    showAlert('Lütfen kayıt seçin');
    return;
  }
  fetch('/requests/delete', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ids: ids})
  }).then(r => r.json()).then(() => location.reload());
});
document.querySelectorAll('.toggle-group').forEach(btn => {
  btn.addEventListener('click', () => {
    const group = btn.dataset.group;
    document.querySelectorAll('.group-' + group).forEach(row => {
      row.classList.toggle('d-none');
    });
    const icon = btn.querySelector('i');
    icon.classList.toggle('bi-caret-right-fill');
    icon.classList.toggle('bi-caret-down-fill');
  });
});
const today = "{{ today }}";
function setupRow(row){
  const typeSelect = row.querySelector('.type-select');
  const donanimFields = row.querySelectorAll('.donanim-field');
  const lisansField = row.querySelector('.lisans-field');
  const aksesuarField = row.querySelector('.aksesuar-field');
  const removeBtn = row.querySelector('.remove-row');
  removeBtn.addEventListener('click', () => {
    const rows = document.querySelectorAll('.request-row');
    if(rows.length > 1){
      row.remove();
    } else {
      showAlert('En az bir satır olmalı');
    }
  });
  typeSelect.addEventListener('change', () => {
    if(typeSelect.value === 'lisans'){
      donanimFields.forEach(f => { f.classList.add('d-none'); const sel = f.querySelector('select'); if(sel) sel.value = ''; });
      aksesuarField.classList.add('d-none');
      const urSel = aksesuarField.querySelector('select'); if(urSel) urSel.value = '';
      lisansField.classList.remove('d-none');
    } else if(typeSelect.value === 'aksesuar'){
      donanimFields.forEach(f => { f.classList.add('d-none'); const sel = f.querySelector('select'); if(sel) sel.value = ''; });
      const lisSel = lisansField.querySelector('select'); if(lisSel) lisSel.value = '';
      lisansField.classList.add('d-none');
      aksesuarField.classList.remove('d-none');
    } else {
      donanimFields.forEach(f => f.classList.remove('d-none'));
      const lisSel = lisansField.querySelector('select'); if(lisSel) lisSel.value = '';
      lisansField.classList.add('d-none');
      aksesuarField.classList.add('d-none');
      const urSel = aksesuarField.querySelector('select'); if(urSel) urSel.value = '';
    }
  });
}
document.querySelectorAll('.request-row').forEach(setupRow);
document.getElementById('add-row').addEventListener('click', () => {
  const rows = document.getElementById('request-rows');
  const first = rows.querySelector('.request-row');
  const clone = first.cloneNode(true);
  clone.querySelectorAll('input').forEach(inp => {
    if(inp.type !== 'hidden') inp.value = '';
    if(inp.name === 'tarih') inp.value = today;
    if(inp.name === 'aciklama') inp.value = '';
  });
  clone.querySelectorAll('select').forEach(sel => sel.selectedIndex = 0);
  clone.querySelector('.type-select').value = 'donanim';
  clone.querySelectorAll('.donanim-field').forEach(f => f.classList.remove('d-none'));
  clone.querySelector('.lisans-field').classList.add('d-none');
  clone.querySelector('.aksesuar-field').classList.add('d-none');
  rows.appendChild(clone);
  setupRow(clone);
});
document.querySelector('form').addEventListener('submit', () => {
  document.querySelectorAll('.request-row').forEach(row => {
    const type = row.querySelector('.type-select').value;
    let urun = '';
    if(type === 'lisans'){
      urun = row.querySelector('.yazilim-adi').value;
    } else if(type === 'aksesuar'){
      urun = row.querySelector('.aksesuar-field select').value;
    } else {
      const tip = row.querySelector('.donanim-tipi').value;
      const marka = row.querySelector('.marka').value;
      const model = row.querySelector('.model').value;
      urun = [tip, marka, model].filter(Boolean).join(' ');
    }
    row.querySelector('input[name="urun_adi"]').value = urun;
  });
});
</script>
{% endblock %}

