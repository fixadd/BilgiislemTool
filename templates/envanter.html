{% extends "base.html" %}
{% set column_labels = {
  'no': 'Envanter No',
  'fabrika': 'Fabrika',
  'blok': 'Blok',
  'departman': 'Departman',
  'donanim_tipi': 'Donanım Tipi',
  'bilgisayar_adi': 'Bilgisayar Adı',
  'marka': 'Marka',
  'model': 'Model',
  'seri_no': 'Seri No',
  'sorumlu_personel': 'Sorumlu Personel',
  'kullanim_alani': 'Kullanım Alanı',
  'bagli_makina_no': 'Bağlı Olduğu Makina No',
  'ifs_no': 'IFS No',
  'tarih': 'Tarih',
  'islem_yapan': 'İşlem Yapan'
} %}
{% block title %}Envanter Takip{% endblock %}
{% block content %}
<div class="container-fluid p-2 content">
  <div class="d-flex align-items-center justify-content-between mb-2">
    <h1 class="h4 m-0">Donanım Envanteri</h1>
    <span class="badge bg-secondary">{{ count }} kayıt var</span>
  </div>

  <div class="d-flex gap-2 mb-2">
  <button class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#settingsModal">
    <i class="bi bi-gear"></i>
  </button>
  <button class="btn btn-success d-flex align-items-center gap-1" data-bs-toggle="modal" data-bs-target="#addModal">
    <i class="bi bi-plus"></i> Yeni Kayıt
  </button>
  <button id="export-excel" class="btn btn-success" style="width:40px;height:40px;display:flex;align-items:center;justify-content:center;">
    <i class="bi bi-download"></i>
  </button>
  <button id="edit-selected" type="button" class="btn btn-warning d-flex align-items-center gap-1">
    <i class="bi bi-pencil"></i> Düzenle
  </button>
  <button id="delete-selected" type="button" class="btn btn-danger d-flex align-items-center gap-1">
    <i class="bi bi-trash"></i> Sil
  </button>
  <button class="btn btn-primary d-flex align-items-center gap-1" data-bs-toggle="modal" data-bs-target="#stockModal">
    <i class="bi bi-box-arrow-in-down"></i> Stock Giriş
  </button>
  <form id="search-form" method="get" class="d-flex gap-2 align-items-center flex-nowrap">
    <input type="text" name="q" value="{{ q }}" class="form-control form-control-sm" placeholder="Ara..." style="max-width:200px;">
    <div class="position-relative d-flex gap-2">
      <div id="filters-container" class="filters-popup d-none flex-column gap-2">
        <div id="filter-rows" class="d-flex flex-column gap-2"></div>
        <button type="button" id="add-filter-row" class="btn btn-success" style="width:40px;height:40px;display:flex;align-items:center;justify-content:center;">+</button>
      </div>
      <button id="add-filter" type="button" class="btn btn-primary" style="width:40px;height:40px;display:flex;align-items:center;justify-content:center;">
        <i class="bi bi-search"></i>
      </button>
      <button id="clear-filter" type="button" class="btn btn-secondary d-none" style="width:40px;height:40px;display:flex;align-items:center;justify-content:center;">
        <i class="bi bi-x"></i>
      </button>
    </div>
    <select id="per-page" name="per_page" class="form-select form-select-sm" style="max-width: 100px;">
      {% for opt in [25,50,100] %}
      <option value="{{ opt }}" {% if per_page == opt %}selected{% endif %}>{{ opt }}</option>
      {% endfor %}
    </select>
  </form>
</div>


<div class="modal fade" id="settingsModal" tabindex="-1" aria-labelledby="settingsModalLabel" aria-hidden="true">
    <div class="modal-dialog w-200">
    <div class="modal-content"style="width:400px;">
      <div class="modal-header">
        <h5 class="modal-title" id="settingsModalLabel">Kolon Ayarları</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
      </div>
        <div class="modal-body"><ul id="columns-list" class="list-group"></ul></div>
      <div class="modal-footer">
        <button id="save-settings" type="button" class="btn btn-primary">Kaydet</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
</div>
</div>
</div>
</div>

<div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editModalLabel">Kayıt Düzenle</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
      </div>
      <form id="editForm" action="/inventory/add" method="post">
        <input type="hidden" name="item_id">
        <input type="hidden" name="kategori" value="inventory">
          <div class="modal-body">
            <div class="row row-cols-4 g-3">
            {% for col in columns %}
            {% if col not in ['islem_yapan', 'ifs_no', 'tarih'] %}
            <div class="col">
              <label class="form-label">{{ column_labels.get(col, col.replace('_', ' ').title()) }}</label>
              {% if lookups.get(col) %}
              <select class="form-select form-select-sm w-200" name="{{ col }}" {% if col != 'bagli_makina_no' %}required{% endif %}>
                <option value="" disabled selected>Seçiniz</option>
                {% for val in lookups.get(col) %}
                <option value="{{ val }}">{{ val }}</option>
                {% endfor %}
              </select>
              {% else %}
              <input type="text" class="form-control form-control-sm w-200" name="{{ col }}" {% if col != 'bagli_makina_no' %}required{% endif %}>
              {% endif %}
            </div>
            {% endif %}
            {% endfor %}
            <input type="hidden" name="tarih" value="{{ today }}">
            </div>
            {% include 'partials/inventory_history.html' %}
          </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-warning">Kaydet</button>
        </div>
      </form>
    </div>
  </div>
</div>
<div class="modal fade" id="addModal" tabindex="-1" aria-labelledby="addModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addModalLabel">Yeni Kayıt</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
      </div>
      <form id="addForm" action="/inventory/add" method="post">
          <input type="hidden" name="kategori" value="inventory">
          <div class="modal-body">
            <div class="row row-cols-4 g-3">
            {% for col in columns %}
            {% if col not in ['islem_yapan', 'ifs_no', 'tarih'] %}
            <div class="col">
              <label class="form-label">{{ column_labels.get(col, col.replace('_', ' ').title()) }}</label>
              {% if lookups.get(col) %}
              <select class="form-select form-select-sm w-200" name="{{ col }}" {% if col != 'bagli_makina_no' %}required{% endif %}>
                <option value="" disabled selected>Seçiniz</option>
                {% for val in lookups.get(col) %}
                <option value="{{ val }}">{{ val }}</option>
                {% endfor %}
              </select>
              {% else %}
              <input type="text" class="form-control form-control-sm w-200" name="{{ col }}" {% if col != 'bagli_makina_no' %}required{% endif %}>
              {% endif %}
            </div>
            {% endif %}
            {% endfor %}
            <input type="hidden" name="tarih" value="{{ today }}">
            </div>
          </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-success">Ekle</button>
        </div>
  </form>
    </div>
  </div>
</div>

{% set stock_category = 'inventory' %}
{% include 'partials/stock_add_modal.html' %}

  <div class="table-scroll">
    <table class="table table-sm table-striped table-hover table-fixed table-resizable mb-0">
      <thead>
        <tr>
          <th><input type="checkbox" id="select-all"></th>
          <th>#</th>
          {% for col in columns %}
          <th data-col="{{ col }}"{% if column_widths.get(col) %} style="width: {{ column_widths[col] }}px;"{% endif %}>{{ column_labels.get(col, col.replace('_', ' ').title()) }}</th>
          {% endfor %}
        </tr>
      </thead>
      <tbody>
        {% for i in items %}
        <tr>
          <td><input class="form-check-input row-check" type="checkbox" value="{{ i.id }}"></td>
          <td>{{ loop.index + offset }}</td>
          {% for col in columns %}
          <td data-col="{{ col }}"{% if column_widths.get(col) %} style="width: {{ column_widths[col] }}px;"{% endif %}>{{ i|attr(col) }}</td>
          {% endfor %}
        </tr>
        {% endfor %}
      </tbody>
    </table>

  </div>

  <nav aria-label="Sayfalar" class="mt-2">
    <ul class="pagination justify-content-center">
  {% set start = ((page - 1) // 10) * 10 + 1 %}
  {% set end = start + 9 if start + 9 < total_pages else total_pages %}
  {% if page > 1 %}
  <li class="page-item"><a class="page-link" href="/inventory?page={{ page - 1 }}&per_page={{ per_page }}&q={{ q }}">Önceki</a></li>
  {% endif %}
  {% for p in range(start, end + 1) %}
  <li class="page-item {% if p == page %}active{% endif %}"><a class="page-link" href="/inventory?page={{ p }}&per_page={{ per_page }}&q={{ q }}">{{ p }}</a></li>
  {% endfor %}
  {% if page < total_pages %}
  <li class="page-item"><a class="page-link" href="/inventory?page={{ page + 1 }}&per_page={{ per_page }}&q={{ q }}">Sonraki</a></li>
  <li class="page-item"><a class="page-link" href="/inventory?page={{ total_pages }}&per_page={{ per_page }}&q={{ q }}">&raquo;&raquo;</a></li>
  {% endif %}
</ul>
</nav>


<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog w-200">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-exclamation-triangle-fill text-danger me-2"></i>Silme Onayı</h5>
      </div>
        <div class="modal-body"></div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
        <button id="confirm-delete" type="button" class="btn btn-danger">Sil</button>
      </div>
  </div>
</div>
</div>
{% endblock %}

{% block scripts %}
<script>
const tableName = "{{ table_name }}";
const currentUserId = {{ current_user_id }};
const columnLabels = {{ column_labels | tojson }};
window.tableName = tableName;
window.filterEndpoint = "/column-values";
window.availableColumns = {{ columns | tojson }};
window.columnLabels = columnLabels;
window.initialFilters = {{ filters | tojson }};
let currentSettings = {};
fetch(`/column-settings?table_name=${tableName}`)
    .then(r => r.json())
    .then(s => { currentSettings = s; applyColumnSettings(s); });
const settingsModal = document.getElementById('settingsModal');
settingsModal.addEventListener('show.bs.modal', async () => {
    const res = await fetch(`/table-columns?table_name=${tableName}`);
    const allCols = (await res.json()).columns;
    const settingsRes = await fetch(`/column-settings?table_name=${tableName}`);
    const settings = await settingsRes.json();
    const order = (settings.order && settings.order.length) ? settings.order : allCols;
    const visible = new Set((settings.visible && settings.visible.length) ? settings.visible : allCols);
    const widths = settings.widths || {};
    currentSettings = settings;
    const list = document.getElementById('columns-list');
    list.innerHTML = '';
    order.forEach(col => {
        const li = document.createElement('li');
        li.className = 'list-group-item d-flex align-items-center';
        li.draggable = true;
        li.dataset.col = col;
        li.innerHTML = `<input class="form-check-input me-2" type="checkbox" ${visible.has(col) ? 'checked' : ''}> <span class="flex-grow-1">${columnLabels[col] || col}</span><input type="number" class="form-control form-control-sm ms-2 width-input" style="width:80px" value="${widths[col] || ''}" placeholder="px">`;
        list.appendChild(li);
    });
    let drag;
    list.addEventListener('dragstart', e => { drag = e.target.closest('li'); });
    list.addEventListener('dragover', e => e.preventDefault());
    list.addEventListener('drop', e => {
        e.preventDefault();
        const target = e.target.closest('li');
        if (target && drag !== target) {
            list.insertBefore(drag, target.nextSibling);
        }
    });
});

document.getElementById('save-settings').addEventListener('click', async () => {
    const items = document.querySelectorAll('#columns-list li');
    const order = Array.from(items).map(li => li.dataset.col);
    const visible = Array.from(items)
        .filter(li => li.querySelector('input[type="checkbox"]').checked)
        .map(li => li.dataset.col);
    const widths = {};
    items.forEach(li => {
        const val = parseInt(li.querySelector('.width-input').value);
        if (!isNaN(val)) widths[li.dataset.col] = val;
    });
    currentSettings.order = order;
    currentSettings.visible = visible;
    currentSettings.widths = widths;
    delete currentSettings.filters;
    await fetch(`/column-settings?table_name=${tableName}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ...currentSettings, csrf_token: csrfToken })
    });
    location.reload();
});

const editButton = document.getElementById('edit-selected');

function updateEditButtonState(){
    const checkedCount = document.querySelectorAll('.row-check:checked').length;
    editButton.disabled = checkedCount > 1;
}

document.getElementById('select-all').addEventListener('change', function() {
    document.querySelectorAll('.row-check').forEach(cb => cb.checked = this.checked);
    updateEditButtonState();
});

document.querySelectorAll('.row-check').forEach(cb => {
    cb.addEventListener('change', updateEditButtonState);
});

updateEditButtonState();

document.getElementById('export-excel').addEventListener('click', () => {
    window.location.href = '/inventory/export';
});


editButton.addEventListener('click', () => {
    const checked = document.querySelectorAll('.row-check:checked');
    if (checked.length !== 1) {
        showAlert('Lütfen yalnızca bir satır seçiniz.');
        return;
    }
    const row = checked[0].closest('tr');
    const form = document.getElementById('editForm');
    form.item_id.value = checked[0].value;
    row.querySelectorAll('td[data-col]').forEach(cell => {
        const input = form.querySelector(`[name="${cell.dataset.col}"]`);
        if (input) input.value = cell.innerText.trim();
    });
    const modal = createModal('editModal');
    if (modal) modal.show();
    loadHistory(tableName, form.item_id.value);
});

const deleteModal = createModal('confirmDeleteModal');
document.getElementById('delete-selected').addEventListener('click', () => {
    const ids = Array.from(document.querySelectorAll('.row-check:checked')).map(cb => cb.value);
    if (!ids.length) return;
    if (deleteModal) deleteModal.show();
});

document.getElementById('confirm-delete').addEventListener('click', async () => {
    const ids = Array.from(document.querySelectorAll('.row-check:checked')).map(cb => cb.value);
    await fetch('/inventory/delete', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ids })
    });
    if (deleteModal) deleteModal.hide();
    location.reload();
});
const perPageSelect = document.getElementById('per-page');
if (perPageSelect) {
    perPageSelect.addEventListener('change', () => {
        document.getElementById('search-form').submit();
    });
}
</script>
{% endblock %}
