{% extends "base.html" %}
{% block title %}Envanter Takip{% endblock %}
{% block content %}
<h2>Donanım Envanteri</h2>

<button id="settings-btn">Ayarlar</button>
<div id="settings-modal" style="display:none; position:fixed; top:20%; left:30%; background:#fff; border:1px solid #000; padding:10px;">
    <h3>Kolon Ayarları</h3>
    <ul id="columns-list"></ul>
    <button id="save-settings" type="button">Kaydet</button>
    <button type="button" onclick="document.getElementById('settings-modal').style.display='none'">Kapat</button>
</div>

<form action="/inventory/add" method="post">
    <input type="text" name="demirbas_adi" placeholder="Demirbaş Adı" required>
    <input type="text" name="marka" placeholder="Marka" required>
    <input type="text" name="model" placeholder="Model" required>
    <input type="text" name="seri_no" placeholder="Seri No" required>
    <input type="text" name="lokasyon" placeholder="Lokasyon" required>
    <input type="text" name="zimmetli_kisi" placeholder="Zimmetli Kişi" required>
    <input type="text" name="notlar" placeholder="Notlar">
    <button type="submit">Ekle</button>
    <br><br>
</form>

<form action="/inventory/upload" method="post" enctype="multipart/form-data">
    <input type="file" name="excel_file" accept=".xls,.xlsx" required>
    <button type="submit">Excel Yükle</button>
    <br><br>
</form>

<table border="1">
    <tr>
        {% for col in columns %}
        <th>{{ col.replace('_', ' ').title() }}</th>
        {% endfor %}
        <th>Sil</th>
    </tr>
    {% for i in items %}
    <tr>
        {% for col in columns %}
        <td>{{ i|attr(col) }}</td>
        {% endfor %}
        <td>
            <form action="/inventory/delete/{{ i.id }}" method="post" style="display:inline;">
                <button type="submit">Sil</button>
            </form>
        </td>
    </tr>
    {% endfor %}
</table>

<script>
const tableName = "{{ table_name }}";
document.getElementById('settings-btn').addEventListener('click', async () => {
    const modal = document.getElementById('settings-modal');
    modal.style.display = 'block';
    const res = await fetch(`/table-columns?table_name=${tableName}`);
    const allCols = (await res.json()).columns;
    const settingsRes = await fetch(`/column-settings?table_name=${tableName}`);
    const settings = await settingsRes.json();
    const order = settings.order || allCols;
    const visible = new Set(settings.visible || allCols);
    const list = document.getElementById('columns-list');
    list.innerHTML = '';
    order.forEach(col => {
        const li = document.createElement('li');
        li.draggable = true;
        li.dataset.col = col;
        li.innerHTML = `<label><input type="checkbox" ${visible.has(col) ? 'checked' : ''}> ${col}</label>`;
        list.appendChild(li);
    });
    let drag;
    list.addEventListener('dragstart', e => { drag = e.target; });
    list.addEventListener('dragover', e => e.preventDefault());
    list.addEventListener('drop', e => {
        e.preventDefault();
        if (e.target.tagName === 'LI' && drag !== e.target) {
            list.insertBefore(drag, e.target.nextSibling);
        }
    });
});

document.getElementById('save-settings').addEventListener('click', async () => {
    const items = document.querySelectorAll('#columns-list li');
    const order = Array.from(items).map(li => li.dataset.col);
    const visible = Array.from(items)
        .filter(li => li.querySelector('input').checked)
        .map(li => li.dataset.col);
    await fetch(`/column-settings?table_name=${tableName}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ order, visible })
    });
    location.reload();
});
</script>
{% endblock %}
