{% extends "base.html" %}
{% block title %}Lisans Takip{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center">
  <h2>Lisans Envanteri</h2>
  <span class="badge bg-secondary">{{ count }}</span>
</div>

<div class="d-flex gap-2 mb-3">
  <button class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#settingsModal">
    <i class="bi bi-gear"></i>
  </button>
  <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addModal" style="width:40px;height:40px;display:flex;align-items:center;justify-content:center;">
    <i class="bi bi-plus"></i>
  </button>
  <button id="upload-btn" class="btn btn-success" style="width:40px;height:40px;display:flex;align-items:center;justify-content:center;">
    <i class="bi bi-upload"></i>
  </button>
  <button id="edit-selected" class="btn btn-warning" style="width:40px;height:40px;display:flex;align-items:center;justify-content:center;">
    <i class="bi bi-pencil"></i>
  </button>
  <button id="delete-selected" class="btn btn-danger" style="width:40px;height:40px;display:flex;align-items:center;justify-content:center;">
    <i class="bi bi-trash"></i>
  </button>
</div>

<form id="uploadForm" action="/license/upload" method="post" enctype="multipart/form-data" style="display:none;">
  <input id="excelInput" type="file" name="excel_file" accept=".xls,.xlsx" required>
</form>

<div class="modal fade" id="settingsModal" tabindex="-1" aria-labelledby="settingsModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="settingsModalLabel">Kolon Ayarları</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
      </div>
      <div class="modal-body">
        <ul id="columns-list" class="list-group"></ul>
      </div>
      <div class="modal-footer">
        <button id="save-settings" type="button" class="btn btn-primary">Kaydet</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
</div>
</div>
</div>

<div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editModalLabel">Kayıt Düzenle</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
      </div>
      <form id="editForm" action="/license/add" method="post">
        <input type="hidden" name="license_id">
        <div class="modal-body">
          <select class="form-select mb-2" name="yazilim_adi" required>
            {% for s in softwares %}
            <option value="{{ s.name }}">{{ s.name }}</option>
            {% endfor %}
          </select>
          <input class="form-control mb-2" type="text" name="lisans_anahtari" placeholder="Lisans Anahtarı" required>
          <input class="form-control mb-2" type="number" name="adet" placeholder="Adet" required>
          <input class="form-control mb-2" type="date" name="satin_alma_tarihi" placeholder="Satın Alma Tarihi">
          <input class="form-control mb-2" type="date" name="bitis_tarihi" placeholder="Bitiş Tarihi">
          <input class="form-control mb-2" type="text" name="zimmetli_kisi" placeholder="Zimmetli Kişi" required>
          <input class="form-control mb-2" type="text" name="notlar" placeholder="Notlar">
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-warning">Kaydet</button>
        </div>
      </form>
    </div>
  </div>
</div>
</div>

<div class="modal fade" id="addModal" tabindex="-1" aria-labelledby="addModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addModalLabel">Yeni Kayıt</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
      </div>
      <form id="addForm" action="/license/add" method="post">
        <div class="modal-body">
          <select class="form-select mb-2" name="yazilim_adi" required>
            {% for s in softwares %}
            <option value="{{ s.name }}">{{ s.name }}</option>
            {% endfor %}
          </select>
          <input class="form-control mb-2" type="text" name="lisans_anahtari" placeholder="Lisans Anahtarı" required>
          <input class="form-control mb-2" type="number" name="adet" placeholder="Adet" required>
          <input class="form-control mb-2" type="date" name="satin_alma_tarihi" placeholder="Satın Alma Tarihi">
          <input class="form-control mb-2" type="date" name="bitis_tarihi" placeholder="Bitiş Tarihi">
          <input class="form-control mb-2" type="text" name="zimmetli_kisi" placeholder="Zimmetli Kişi" required>
          <input class="form-control mb-2" type="text" name="notlar" placeholder="Notlar">
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-success">Ekle</button>
        </div>
      </form>
    </div>
  </div>
</div>

<table class="table table-striped table-fixed table-resizable">
    <tr>
        <th><input type="checkbox" id="select-all"></th>
        {% for col in columns %}
        <th{% if column_widths.get(col) %} style="width: {{ column_widths[col] }}px;"{% endif %}>{{ col.replace('_', ' ').title() }}</th>
        {% endfor %}
    </tr>
    {% for l in licenses %}
    <tr>
        <td><input class="form-check-input row-check" type="checkbox" value="{{ l.id }}"></td>
        {% for col in columns %}
        <td{% if column_widths.get(col) %} style="width: {{ column_widths[col] }}px; white-space: normal; word-break: break-word;"{% else %} style="white-space: normal; word-break: break-word;"{% endif %}>{{ l|attr(col) }}</td>
        {% endfor %}
    </tr>
    {% endfor %}
</table>

<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-exclamation-triangle-fill text-danger me-2"></i>Silme Onayı</h5>
      </div>
      <div class="modal-body">Seçili kayıtları silmek istediğinizden emin misiniz?</div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
        <button id="confirm-delete" type="button" class="btn btn-danger">Sil</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const tableName = "{{ table_name }}";
const columns = {{ columns|tojson }};
const settingsModal = document.getElementById('settingsModal');
settingsModal.addEventListener('show.bs.modal', async () => {
    const res = await fetch(`/table-columns?table_name=${tableName}`);
    const allCols = (await res.json()).columns;
    const settingsRes = await fetch(`/column-settings?table_name=${tableName}`);
    const settings = await settingsRes.json();
    const order = settings.order || allCols;
    const visible = new Set(settings.visible || allCols);
    const widths = settings.widths || {};
    const list = document.getElementById('columns-list');
    list.innerHTML = '';
    order.forEach(col => {
        const li = document.createElement('li');
        li.className = 'list-group-item d-flex align-items-center';
        li.draggable = true;
        li.dataset.col = col;
        li.innerHTML = `<input class="form-check-input me-2" type="checkbox" ${visible.has(col) ? 'checked' : ''}> <span class="flex-grow-1">${col}</span><input type="number" class="form-control form-control-sm ms-2 width-input" style="width:80px" value="${widths[col] || ''}" placeholder="px">`;
        list.appendChild(li);
    });
    let drag;
    list.addEventListener('dragstart', e => { drag = e.target.closest('li'); });
    list.addEventListener('dragover', e => e.preventDefault());
    list.addEventListener('drop', e => {
        e.preventDefault();
        const target = e.target.closest('li');
        if (target && drag !== target) {
            list.insertBefore(drag, target.nextSibling);
        }
    });
});

document.getElementById('save-settings').addEventListener('click', async () => {
    const items = document.querySelectorAll('#columns-list li');
    const order = Array.from(items).map(li => li.dataset.col);
    const visible = Array.from(items)
        .filter(li => li.querySelector('input[type="checkbox"]').checked)
        .map(li => li.dataset.col);
    const widths = {};
    items.forEach(li => {
        const val = parseInt(li.querySelector('.width-input').value);
        if (!isNaN(val)) widths[li.dataset.col] = val;
    });
    await fetch(`/column-settings?table_name=${tableName}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ order, visible, widths })
    });
    location.reload();
});

document.getElementById('select-all').addEventListener('change', function() {
    document.querySelectorAll('.row-check').forEach(cb => cb.checked = this.checked);
});

document.getElementById('upload-btn').addEventListener('click', () => {
    document.getElementById('excelInput').click();
});
document.getElementById('excelInput').addEventListener('change', () => {
    document.getElementById('uploadForm').submit();
});

document.getElementById('edit-selected').addEventListener('click', () => {
    const checked = document.querySelectorAll('.row-check:checked');
    if (checked.length !== 1) {
        alert('Lütfen yalnızca bir satır seçiniz.');
        return;
    }
    const row = checked[0].closest('tr');
    const cells = row.querySelectorAll('td');
    const form = document.getElementById('editForm');
    form.license_id.value = checked[0].value;
    columns.forEach((col, idx) => {
        const input = form.querySelector(`[name="${col}"]`);
        if (input) input.value = cells[idx + 1].innerText.trim();
    });
    const modal = new bootstrap.Modal(document.getElementById('editModal'));
    modal.show();
});

const deleteModal = new bootstrap.Modal(document.getElementById('confirmDeleteModal'));
document.getElementById('delete-selected').addEventListener('click', () => {
    const ids = Array.from(document.querySelectorAll('.row-check:checked')).map(cb => cb.value);
    if (!ids.length) return;
    deleteModal.show();
});

document.getElementById('confirm-delete').addEventListener('click', async () => {
    const ids = Array.from(document.querySelectorAll('.row-check:checked')).map(cb => cb.value);
    await fetch('/license/delete', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ids })
    });
    deleteModal.hide();
    location.reload();
});
</script>
{% endblock %}
